name: Godot RDP with Ngrok

on: [workflow_dispatch]

jobs:
  rdp-setup:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Configure RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString "P@ssw0rd!" -AsPlainText -Force)

    - name: Install Ngrok
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip
        .\ngrok\ngrok.exe authtoken $Env:NGROK_TOKEN
      env:
        NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}

    - name: Start Ngrok and Fetch Tunnel Info
      run: |
        # تشغيل Ngrok في الخلفية
        $ngrokProcess = Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 3389" -PassThru
        
        # الانتظار حتى يصبح Ngrok جاهزًا (حتى 30 ثانية)
        $attempts = 0
        $maxAttempts = 30
        $tunnelReady = $false
        
        while ($attempts -lt $maxAttempts -and !$tunnelReady) {
          try {
            $response = Invoke-WebRequest "http://localhost:4040/api/tunnels" -ErrorAction Stop
            $tunnelInfo = $response.Content | ConvertFrom-Json
            $publicUrl = $tunnelInfo.tunnels[0].public_url
            Write-Host "Ngrok Tunnel URL: $publicUrl"
            $tunnelReady = $true
          } catch {
            Write-Host "Waiting for Ngrok to start... (Attempt $($attempts + 1)/$maxAttempts)"
            Start-Sleep -Seconds 1
            $attempts++
          }
        }

        if (!$tunnelReady) {
          Write-Host "Failed to get Ngrok tunnel after $maxAttempts attempts"
          exit 1
        }

        # عرض معلومات الاتصال
        Write-Host "========================================"
        Write-Host "RDP Connection Details:"
        Write-Host "URL: $publicUrl"
        Write-Host "Username: runneradmin"
        Write-Host "Password: P@ssw0rd!"
        Write-Host "========================================"

        # الحفاظ على الجلسة نشطة
        Wait-Process -Id $ngrokProcess.Id
